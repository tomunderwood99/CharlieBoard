<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: black;
        }
        h1 {
            color: white;
            background-color: black;
            text-align: center;
            padding: 10px;
        }
        h2 {
            color: black;
            text-align: center;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="color"], input[type="time"], input[type="range"], select {
            width: 100%;
            max-width: 200px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inline-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .box {
            border: 2px solid #000;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .inline-switches {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Spinner animation for system status loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .status-healthy {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-unhealthy {
            color: #dc3545;
            font-weight: bold;
        }
        
        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .status-error {
            color: #ffc107;
            font-weight: bold;
        }
        
        .component-status {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            background: #fff;
            border-left: 4px solid #dee2e6;
        }
        
        .component-status.healthy {
            border-left-color: #28a745;
        }
        
        .component-status.unhealthy {
            border-left-color: #dc3545;
        }
        
        .component-status.error {
            border-left-color: #ffc107;
        }

        .toggle-button, .save-button, .slider-container {
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: background-color 0.1s; /* Shorter transition for faster updates */
            height: 44px; /* Set a consistent height for buttons and slider container */
            box-sizing: border-box;
            width: 100%; /* Stretch to fill the container */
        }

        .slider-container {
            background-color: #d3d3d3; /* Light gray background for slider container */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-button.off {
            background-color: #ccc;
        }

        .toggle-button.on {
            background-color: #2196F3;
        }

        .save-button {
            background-color: #4CAF50; /* Green */
            transition: background-color 0.3s ease;
        }

        .save-button:hover {
            background-color: #45a049; /* Darker green */
        }

        .save-button.saved {
            background-color: #9e9e9e; /* Gray */
            cursor: default;
        }

        .save-button.saved:hover {
            background-color: #9e9e9e; /* Stay gray on hover */
        }

        .save-button.unsaved {
            background-color: #4CAF50; /* Green */
        }

        .save-button.unsaved:hover {
            background-color: #45a049; /* Darker green */
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px; /* Add space between items */
        }

        .top-control-item {
            flex: 1; /* Make each item take equal space */
        }

        input[type="range"] {
            width: 90%; /* Use most of the width of the container */
            margin: 0; /* Remove default margin */
            background: transparent; /* Remove default background */
            appearance: none; /* Remove default styling */
            height: 44px; /* Match the height of buttons */
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px; /* Thin line */
            background: black; /* Black line */
            border-radius: 2px;
        }

        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 4px; /* Thin line */
            background: black; /* Black line */
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background-color: var(--thumb-color, #2196F3);
            border-radius: 50%;
            border: 2px solid black; /* Black outline */
            cursor: pointer;
            transition: background-color 0.1s; /* Shorter transition for faster updates */
            margin-top: -8px; /* Center the thumb on the track */
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background-color: var(--thumb-color, #2196F3);
            border-radius: 50%;
            border: 2px solid black; /* Black outline */
            cursor: pointer;
            transition: background-color 0.1s; /* Shorter transition for faster updates */
        }

        .inline-controls, .inline-switches {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .color-selector, .debugger-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc((100% / 3) - 10px); /* Divide the width equally and add buffer */
        }

        input[type="color"] {
            width: 100%; /* Use full width of the container */
            height: 44px; /* Match the height of buttons */
            padding: 0; /* Remove padding for color inputs */
            border: none;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .mode-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 30px !important;
        }

        .mode-select:hover {
            background-color: #1976D2;
        }

        .mode-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.4);
        }

        /* Collapsible health status styles */
        .health-collapsible {
            background-color: #f1f1f1;
            color: #333;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .health-collapsible:hover {
            background-color: #ddd;
        }

        .health-collapsible.active {
            background-color: #ddd;
        }

        .health-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #f9f9f9;
            border-radius: 0 0 5px 5px;
        }

        .health-content-inner {
            padding: 15px;
        }

        .caret {
            transition: transform 0.3s;
            display: inline-block;
        }

        .caret.down {
            transform: rotate(90deg);
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .top-controls {
                flex-direction: column;
            }

            .top-control-item {
                width: 100%;
                margin-bottom: 10px;
            }

            .slider-container {
                order: -1; /* Move brightness slider to top on mobile */
            }

            input[type="range"] {
                width: 95%;
            }

            /* Remove max-width restriction on mode selector in mobile view */
            .top-controls .mode-select {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <h1>Display Controller</h1>

    <!-- Hidden input for default route -->
    <input type="hidden" id="route" name="route" value="Red">

    <!-- 2) LED Brightness, Mode selector, On/off switch, Save button -->
    <div class="box top-controls">
        <div class="top-control-item slider-container">
            <input type="range" id="brightness" name="brightness" min="0" max="1" step="0.01" 
                value="{{ settings.get('BRIGHTNESS', 0.5) }}" oninput="updateSliderThumbColor(this)">
        </div>
        <div class="top-control-item">
            <select id="display-mode" class="mode-select" style="width: 100%; height: 44px; border-radius: 5px; background-color: #2196F3; color: white; border: none; padding: 0 10px; cursor: pointer;">
                <option value="vehicles" title="Show train locations and movements" {% if settings.get('DISPLAY_MODE') == 'vehicles' %}selected{% endif %}>Vehicles</option>
                <option value="speed" title="Display train speeds using color intensity" {% if settings.get('DISPLAY_MODE') == 'speed' %}selected{% endif %}>Speed</option>
                <option value="occupancy" title="Show passenger occupancy levels at stations" {% if settings.get('DISPLAY_MODE') == 'occupancy' %}selected{% endif %}>Occupancy</option>
                <option value="rainbow" title="Display a moving rainbow pattern" {% if settings.get('DISPLAY_MODE') == 'rainbow' %}selected{% endif %}>Rainbow</option>
            </select>
        </div>
        <div class="top-control-item">
            <button id="power-switch-btn" class="toggle-button {{ 'on' if settings.get('POWER_SWITCH') == 'on' else 'off' }}" 
                onclick="toggleButton('power-switch-btn')">Display {{ 'On' if settings.get('POWER_SWITCH') == 'on' else 'Off' }}</button>
        </div>
        <div class="top-control-item">
            <button id="save-button" class="save-button saved" onclick="saveSettings()">Settings Saved</button>
        </div>
    </div>

    <!-- 3) Train Status Colors and Color Selectors -->
    <div class="box control-group">
        <div class="inline-controls" id="vehicle-colors">
            <div class="color-selector">
                <label for="transit-color">Next Stop:</label>
                <input type="color" id="transit-color" name="transit-color" 
                    value="{% set color = settings.get('TRANSIT_COLOR', [150, 150, 150]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="incoming-color">Approaching:</label>
                <input type="color" id="incoming-color" name="incoming-color" 
                    value="{% set color = settings.get('INCOMING_COLOR', [255, 75, 75]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="stopped-color">Arrived:</label>
                <input type="color" id="stopped-color" name="stopped-color" 
                    value="{% set color = settings.get('STOPPED_COLOR', [255, 0, 0]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
        </div>
        <div class="inline-controls" id="speed-colors" style="display: none;">
            <div class="color-selector">
                <label for="min-speed-color">Min Speed:</label>
                <input type="color" id="min-speed-color" name="min-speed-color" 
                    value="{% set color = settings.get('MIN_SPEED_COLOR', [0, 255, 0]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="max-speed-color">Max Speed:</label>
                <input type="color" id="max-speed-color" name="max-speed-color" 
                    value="{% set color = settings.get('MAX_SPEED_COLOR', [255, 0, 0]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="null-speed-color">No Data:</label>
                <input type="color" id="null-speed-color" name="null-speed-color" 
                    value="{% set color = settings.get('NULL_SPEED_COLOR', [0, 0, 255]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
        </div>
        <div class="inline-controls" id="occupancy-colors" style="display: none;">
            <div class="color-selector">
                <label for="min-occupancy-color">Min Occupancy:</label>
                <input type="color" id="min-occupancy-color" name="min-occupancy-color" 
                    value="{% set color = settings.get('MIN_OCCUPANCY_COLOR', [0, 255, 0]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="max-occupancy-color">Max Occupancy:</label>
                <input type="color" id="max-occupancy-color" name="max-occupancy-color" 
                    value="{% set color = settings.get('MAX_OCCUPANCY_COLOR', [255, 0, 0]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
            <div class="color-selector">
                <label for="null-occupancy-color">No Data:</label>
                <input type="color" id="null-occupancy-color" name="null-occupancy-color" 
                    value="{% set color = settings.get('NULL_OCCUPANCY_COLOR', [0, 0, 255]) %}#{{ '%02x%02x%02x' % (color[0], color[1], color[2]) }}">
            </div>
        </div>
    </div>

    <!-- 4) Bedtime Settings and Their Values -->
    <div class="box control-group">
        <div class="inline-controls" style="justify-content: center;">
            <span>Bedtime from</span>
            <input type="time" id="bedtime-start" name="bedtime-start"
                value="{{ settings.get('BEDTIME_START', '22:00') }}" style="width: 100px; text-align: center; margin: 0 10px;">
            <span>to</span>
            <input type="time" id="bedtime-end" name="bedtime-end"
                value="{{ settings.get('BEDTIME_END', '07:00') }}" style="width: 100px; text-align: center; margin: 0 10px;">
        </div>
    </div>

    <!-- 5) Debugger Options and the Switches -->
    {% if settings.get('SHOW_DEBUGGER_OPTIONS', false) %}
    <div class="box control-group">
        <h2>Debugging Options</h2>
        <div class="inline-switches">
            <div class="debugger-option">
                <button id="debugger-time-btn" 
                    class="toggle-button {{ 'on' if 'time' in settings.get('DEBUGGER', []) else 'off' }}" 
                    onclick="toggleButton('debugger-time-btn')">Time</button>
            </div>
            <div class="debugger-option">
                <button id="debugger-color-key-btn" 
                    class="toggle-button {{ 'on' if 'color_key' in settings.get('DEBUGGER', []) else 'off' }}" 
                    onclick="toggleButton('debugger-color-key-btn')">Color Key</button>
            </div>
            <div class="debugger-option">
                <button id="debugger-station-status-btn" 
                    class="toggle-button {{ 'on' if 'station_status' in settings.get('DEBUGGER', []) else 'off' }}" 
                    onclick="toggleButton('debugger-station-status-btn')">Station Status</button>
            </div>
            <div class="debugger-option">
                <button id="rainbow-mode-btn" 
                    class="toggle-button {{ 'on' if settings.get('RAINBOW_MODE') == 'on' else 'off' }}" 
                    onclick="toggleButton('rainbow-mode-btn')">Rainbow Mode</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Collapsible Health Status Section -->
    <div class="box control-group">
        <button type="button" class="health-collapsible" onclick="toggleHealthStatus()">
            <span>Health Status: <span id="health-status-text" class="status-healthy">Loading...</span></span>
            <span class="caret">▶</span>
        </button>
        <div class="health-content" id="health-content">
            <div class="health-content-inner">
                <!-- MBTA API Key Input -->
                <div class="control-group">
                    <label for="mbta-api-key">MBTA API Key:</label>
                    <input type="text" id="mbta-api-key" name="mbta-api-key" value="{{ settings.get('MBTA_API_KEY', '') }}" style="width: 100%;">
                </div>
                
                <!-- System Status Display -->
                <div class="control-group" style="margin-top: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">System Status</h3>
                    <div id="system-status" style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                        <div style="text-align: center; color: #6c757d;">
                            <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <div style="margin-top: 10px;">Loading system status...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function rgbToTuple(rgb) {
            const r = parseInt(rgb.slice(1, 3), 16);
            const g = parseInt(rgb.slice(3, 5), 16);
            const b = parseInt(rgb.slice(5, 7), 16);
            return [r, g, b];
        }

        function updateColorSelectors(mode) {
            // Hide all color selector groups
            document.getElementById('vehicle-colors').style.display = 'none';
            document.getElementById('speed-colors').style.display = 'none';
            document.getElementById('occupancy-colors').style.display = 'none';

            // Show the appropriate color selector group based on mode
            switch(mode) {
                case 'vehicles':
                    document.getElementById('vehicle-colors').style.display = 'flex';
                    break;
                case 'speed':
                    document.getElementById('speed-colors').style.display = 'flex';
                    break;
                case 'occupancy':
                    document.getElementById('occupancy-colors').style.display = 'flex';
                    break;
                // Rainbow mode doesn't need color selectors
            }
        }

        // Add event listener for mode changes
        document.getElementById('display-mode').addEventListener('change', function(e) {
            updateColorSelectors(e.target.value);
        });

        function saveSettings() {
            // Check if button is in saved state (disabled)
            const saveButton = document.getElementById('save-button');
            if (saveButton.classList.contains('saved')) {
                return; // Don't save if already saved
            }

            const debuggerOptions = [];
            // Safely check for debugger buttons - they might not exist if hidden
            const timeBtn = document.getElementById('debugger-time-btn');
            const colorKeyBtn = document.getElementById('debugger-color-key-btn');
            const stationStatusBtn = document.getElementById('debugger-station-status-btn');
            const rainbowBtn = document.getElementById('rainbow-mode-btn');
            
            if (timeBtn && timeBtn.classList.contains('on')) debuggerOptions.push('time');
            if (colorKeyBtn && colorKeyBtn.classList.contains('on')) debuggerOptions.push('color_key');
            if (stationStatusBtn && stationStatusBtn.classList.contains('on')) debuggerOptions.push('station_status');

            const displayMode = document.getElementById('display-mode').value;
            const settings = {
                'route': document.getElementById('route').value,
                'bedtime_start': document.getElementById('bedtime-start').value || '22:00',
                'bedtime_end': document.getElementById('bedtime-end').value || '07:00',
                'brightness': document.getElementById('brightness').value,
                'display_mode': displayMode,
                'power_switch': document.getElementById('power-switch-btn').classList.contains('on') ? 'on' : 'off',
                'debugger': debuggerOptions,
                'rainbow_mode': rainbowBtn && rainbowBtn.classList.contains('on') ? 'on' : 'off',
                // Always include all color settings
                // Vehicle mode colors
                'stopped_color': rgbToTuple(document.getElementById('stopped-color').value),
                'incoming_color': rgbToTuple(document.getElementById('incoming-color').value),
                'transit_color': rgbToTuple(document.getElementById('transit-color').value),
                // Speed mode colors
                'min_speed_color': rgbToTuple(document.getElementById('min-speed-color').value),
                'max_speed_color': rgbToTuple(document.getElementById('max-speed-color').value),
                'null_speed_color': rgbToTuple(document.getElementById('null-speed-color').value),
                // Occupancy mode colors
                'min_occupancy_color': rgbToTuple(document.getElementById('min-occupancy-color').value),
                'max_occupancy_color': rgbToTuple(document.getElementById('max-occupancy-color').value),
                'null_occupancy_color': rgbToTuple(document.getElementById('null-occupancy-color').value)
            };

            // Only include the MBTA API key if it's been changed from the masked value
            const mbtaApiKey = document.getElementById('mbta-api-key').value;
            if (mbtaApiKey.trim() !== '' && mbtaApiKey !== '********') {
                settings['mbta_api_key'] = mbtaApiKey;
            } else if (mbtaApiKey === '********') {
                settings['mbta_api_key'] = '********';  // This will signal the backend to keep the existing key
            }

            fetch('/save_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                // Update button to saved state
                setSaveButtonState('saved');
                // Store current settings as the "saved" state
                storeCurrentSettings();
                console.log('Settings saved successfully');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving settings: ' + error.message);
            });
        }

        function toggleButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.classList.toggle('on');
            button.classList.toggle('off');
            if (buttonId === 'power-switch-btn') {
                button.textContent = button.classList.contains('on') ? 'Display On' : 'Display Off';
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/get_settings');
                if (!response.ok) {
                    throw new Error('Failed to fetch settings');
                }
                const settings = await response.json();

                // Load mode-specific colors
                const displayMode = getSetting(settings, 'display_mode', 'vehicles');
                document.getElementById('display-mode').value = displayMode;
                updateColorSelectors(displayMode);

                // Load colors based on mode - use helper function for safe color retrieval
                switch(displayMode) {
                    case 'vehicles':
                        document.getElementById('stopped-color').value = rgbToHex(getColorSetting(settings, 'stopped_color', [255, 0, 0]));
                        document.getElementById('incoming-color').value = rgbToHex(getColorSetting(settings, 'incoming_color', [255, 75, 75]));
                        document.getElementById('transit-color').value = rgbToHex(getColorSetting(settings, 'transit_color', [150, 150, 150]));
                        break;
                    case 'speed':
                        document.getElementById('min-speed-color').value = rgbToHex(getColorSetting(settings, 'min_speed_color', [0, 255, 0]));
                        document.getElementById('max-speed-color').value = rgbToHex(getColorSetting(settings, 'max_speed_color', [255, 0, 0]));
                        document.getElementById('null-speed-color').value = rgbToHex(getColorSetting(settings, 'null_speed_color', [0, 0, 255]));
                        break;
                    case 'occupancy':
                        document.getElementById('min-occupancy-color').value = rgbToHex(getColorSetting(settings, 'min_occupancy_color', [0, 255, 0]));
                        document.getElementById('max-occupancy-color').value = rgbToHex(getColorSetting(settings, 'max_occupancy_color', [255, 0, 0]));
                        document.getElementById('null-occupancy-color').value = rgbToHex(getColorSetting(settings, 'null_occupancy_color', [0, 0, 255]));
                        break;
                }

                // Load other settings using safe helper functions
                document.getElementById('bedtime-start').value = getSetting(settings, 'bedtime_start', '22:00');
                document.getElementById('bedtime-end').value = getSetting(settings, 'bedtime_end', '07:00');
                const brightnessValue = getSetting(settings, 'brightness', 0.5);
                const brightnessSlider = document.getElementById('brightness');
                brightnessSlider.value = brightnessValue;
                updateSliderThumbColor(brightnessSlider);
                
                const powerSwitch = getSetting(settings, 'power_switch', 'off');
                document.getElementById('power-switch-btn').classList.toggle('on', powerSwitch === 'on');
                document.getElementById('power-switch-btn').classList.toggle('off', powerSwitch !== 'on');
                document.getElementById('power-switch-btn').textContent = powerSwitch === 'on' ? 'Display On' : 'Display Off';

                // Safe debugger array handling - buttons might not exist if hidden
                const debuggerOptions = getSetting(settings, 'debugger', []);
                const debuggerArray = Array.isArray(debuggerOptions) ? debuggerOptions : [];
                
                const timeBtn = document.getElementById('debugger-time-btn');
                const colorKeyBtn = document.getElementById('debugger-color-key-btn');
                const stationStatusBtn = document.getElementById('debugger-station-status-btn');
                const rainbowBtn = document.getElementById('rainbow-mode-btn');
                
                if (timeBtn) {
                    timeBtn.classList.toggle('on', debuggerArray.includes('time'));
                    timeBtn.classList.toggle('off', !debuggerArray.includes('time'));
                }
                
                if (colorKeyBtn) {
                    colorKeyBtn.classList.toggle('on', debuggerArray.includes('color_key'));
                    colorKeyBtn.classList.toggle('off', !debuggerArray.includes('color_key'));
                }
                
                if (stationStatusBtn) {
                    stationStatusBtn.classList.toggle('on', debuggerArray.includes('station_status'));
                    stationStatusBtn.classList.toggle('off', !debuggerArray.includes('station_status'));
                }

                // Load rainbow mode setting
                const rainbowMode = getSetting(settings, 'rainbow_mode', 'off');
                if (rainbowBtn) {
                    rainbowBtn.classList.toggle('on', rainbowMode === 'on');
                    rainbowBtn.classList.toggle('off', rainbowMode !== 'on');
                }

                // Load MBTA API Key
                document.getElementById('mbta-api-key').value = getSetting(settings, 'mbta_api_key', '');
                
                // Store loaded settings as the baseline for change detection
                setTimeout(() => {
                    storeCurrentSettings();
                    setSaveButtonState('saved');
                }, 50);
            } catch (error) {
                console.error('Error loading settings:', error);
                setDefaults(); // Set default values if loading fails
            }
        }

        function setDefaults() {
            // Set default values for all controls
            document.getElementById('display-mode').value = 'vehicles';
            updateColorSelectors('vehicles');
            
            // Set default colors
            document.getElementById('stopped-color').value = '#ff0000';
            document.getElementById('incoming-color').value = '#ff4b4b';
            document.getElementById('transit-color').value = '#969696';
            document.getElementById('min-speed-color').value = '#00ff00';
            document.getElementById('max-speed-color').value = '#ff0000';
            document.getElementById('null-speed-color').value = '#0000ff';
            document.getElementById('min-occupancy-color').value = '#00ff00';
            document.getElementById('max-occupancy-color').value = '#ff0000';
            document.getElementById('null-occupancy-color').value = '#0000ff';
            
            // Set default times and brightness
            document.getElementById('bedtime-start').value = '22:00';
            document.getElementById('bedtime-end').value = '07:00';
            const brightnessSlider = document.getElementById('brightness');
            brightnessSlider.value = 0.5;
            updateSliderThumbColor(brightnessSlider);
            
            // Set default switches
            document.getElementById('power-switch-btn').classList.add('off');
            document.getElementById('power-switch-btn').classList.remove('on');
            document.getElementById('power-switch-btn').textContent = 'Display Off';
            
            // Set default debugger options - buttons might not exist if hidden
            const timeBtn = document.getElementById('debugger-time-btn');
            const colorKeyBtn = document.getElementById('debugger-color-key-btn');
            const stationStatusBtn = document.getElementById('debugger-station-status-btn');
            const rainbowBtn = document.getElementById('rainbow-mode-btn');
            
            if (timeBtn) {
                timeBtn.classList.add('off');
                timeBtn.classList.remove('on');
            }
            if (colorKeyBtn) {
                colorKeyBtn.classList.add('off');
                colorKeyBtn.classList.remove('on');
            }
            if (stationStatusBtn) {
                stationStatusBtn.classList.add('off');
                stationStatusBtn.classList.remove('on');
            }
            if (rainbowBtn) {
                rainbowBtn.classList.add('off');
                rainbowBtn.classList.remove('on');
            }
            
            // Clear API key
            document.getElementById('mbta-api-key').value = '';
            
            // Store default settings as the baseline for change detection
            setTimeout(() => {
                storeCurrentSettings();
                setSaveButtonState('saved');
            }, 50);
        }

        function rgbToHex(rgbArray) {
            return '#' + rgbArray.map(x => x.toString(16).padStart(2, '0')).join('');
        }

        function getColorSetting(settings, key, defaultValue) {
            // Try both uppercase and lowercase versions of the key
            const upperKey = key.toUpperCase();
            const lowerKey = key.toLowerCase();
            
            // Check if either key exists and has a non-null/undefined value
            let value = null;
            if (settings.hasOwnProperty(upperKey) && settings[upperKey] !== null && settings[upperKey] !== undefined) {
                value = settings[upperKey];
            } else if (settings.hasOwnProperty(lowerKey) && settings[lowerKey] !== null && settings[lowerKey] !== undefined) {
                value = settings[lowerKey];
            }
            
            // Return the found value or default
            return value !== null ? value : defaultValue;
        }

        function getSetting(settings, key, defaultValue) {
            // Try both uppercase and lowercase versions of the key
            const upperKey = key.toUpperCase();
            const lowerKey = key.toLowerCase();
            
            // Check if either key exists and has a non-null/undefined value
            let value = undefined;
            if (settings.hasOwnProperty(upperKey) && settings[upperKey] !== null && settings[upperKey] !== undefined) {
                value = settings[upperKey];
            } else if (settings.hasOwnProperty(lowerKey) && settings[lowerKey] !== null && settings[lowerKey] !== undefined) {
                value = settings[lowerKey];
            }
            
            // Return the found value or default
            return value !== undefined ? value : defaultValue;
        }

        function updateSliderThumbColor(slider) {
            const value = slider.value;
            const colorValue = Math.floor(value * 255);
            const color = `rgb(${colorValue}, ${colorValue}, ${colorValue})`;
            slider.style.setProperty('--thumb-color', color);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('brightness');
            updateSliderThumbColor(slider);
        });

        window.onload = () => {
            loadSettings(); // Attempt to load settings from server
            loadSystemStatus(); // Load system status
        };

        // Toggle health status collapsible
        function toggleHealthStatus() {
            const content = document.getElementById('health-content');
            const caret = document.querySelector('.health-collapsible .caret');
            const button = document.querySelector('.health-collapsible');
            
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = '0px';
                caret.classList.remove('down');
                button.classList.remove('active');
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                caret.classList.add('down');
                button.classList.add('active');
            }
        }
        
        // System Status Functions
        function formatTimestamp(timestamp) {
            // Handle "Unknown" or invalid timestamps
            if (!timestamp || timestamp === 'Unknown') {
                return 'Unknown';
            }
            
            try {
                const date = new Date(timestamp);
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Unknown';
                }
                
                // Format as HH:MM:SS, DD Month YYYY
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                
                return `${hours}:${minutes}:${seconds}, ${day} ${month} ${year}`;
            } catch (e) {
                return 'Unknown';
            }
        }
        
        function formatSystemResources(status) {
            let html = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">';
            html += '<strong>System Resources:</strong><br>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">';
            
            // Memory usage
            html += '<div>';
            if (status.memory_usage && status.memory_usage !== null) {
                const mem = status.memory_usage;
                html += `<strong>Memory Usage:</strong><br>`;
                html += `Used: ${mem.used_mb}MB / ${mem.total_mb}MB (${mem.percent_used}%)<br>`;
                html += `Free: ${mem.free_mb}MB`;
            } else {
                html += '<strong>Memory Usage:</strong> Not available';
            }
            html += '</div>';
            
            // CPU temperature
            html += '<div>';
            if (status.cpu_temperature !== null && status.cpu_temperature !== undefined) {
                const tempClass = status.cpu_temperature > 70 ? 'status-unhealthy' : 
                                 status.cpu_temperature > 60 ? 'status-warning' : 'status-healthy';
                html += `<strong>CPU Temperature:</strong><br>`;
                html += `<span class="${tempClass}">${status.cpu_temperature}°C</span>`;
            } else {
                html += '<strong>CPU Temperature:</strong> Not available';
            }
            html += '</div>';
            
            html += '</div></div>';
            return html;
        }
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/system_status');
                if (!response.ok) {
                    throw new Error('Failed to fetch system status');
                }
                const status = await response.json();
                displaySystemStatus(status);
            } catch (error) {
                console.error('Error loading system status:', error);
                displaySystemStatusError(error.message);
            }
        }
        
        function displaySystemStatus(status) {
            const statusDiv = document.getElementById('system-status');
            
            if (status.error) {
                displaySystemStatusError(status.error);
                updateHealthStatusText('Error', 'status-error');
                return;
            }
            
            const overallStatus = status.overall_healthy ? 'Healthy' : 'Unhealthy';
            const overallStatusClass = status.overall_healthy ? 'status-healthy' : 'status-unhealthy';
            
            // Update the collapsed view text
            updateHealthStatusText(overallStatus, overallStatusClass);
            
            // Capitalize display mode for better readability
            const displayModeFormatted = status.display_mode 
                ? status.display_mode.charAt(0).toUpperCase() + status.display_mode.slice(1) 
                : 'Unknown';
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                        Overall Status: <span class="${overallStatusClass}">${overallStatus}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong>Session Uptime:</strong> ${status.session_uptime}<br>
                            <strong>Total Uptime:</strong> ${status.total_uptime}<br>
                            <strong>Active Vehicles:</strong> ${status.active_vehicles}<br>
                            <strong>Display Mode:</strong> ${displayModeFormatted}
                        </div>
                        <div>
                            <strong>Last LED Update:</strong> ${formatTimestamp(status.last_led_update)}<br>
                            <strong>Last API Success:</strong> ${formatTimestamp(status.last_api_success)}<br>
                            <strong>Session Started:</strong> ${formatTimestamp(status.session_start_time)}<br>
                            <strong>First Deployed:</strong> ${formatTimestamp(status.first_start_time)}<br>
                            <strong>Last Check:</strong> ${formatTimestamp(status.last_check)}
                        </div>
                    </div>
                    ${formatSystemResources(status)}
                </div>
            `;
            
            // Add component status
            html += '<div style="margin-top: 15px;"><strong>Component Status:</strong></div>';
            
            Object.entries(status.components).forEach(([name, component]) => {
                const statusClass = component.healthy ? 'healthy' : 'unhealthy';
                const statusText = component.status;
                const statusColorClass = component.healthy ? 'status-healthy' : 'status-unhealthy';
                
                html += `
                    <div class="component-status ${statusClass}">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${name.charAt(0).toUpperCase() + name.slice(1)}: 
                            <span class="${statusColorClass}">${statusText}</span>
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${component.details}
                        </div>
                    </div>
                `;
            });
            
            // Add refresh button
            html += `
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="loadSystemStatus()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Refresh Status
                    </button>
                </div>
            `;
            
            statusDiv.innerHTML = html;
            
            // Update collapsible height if it's expanded
            const content = document.getElementById('health-content');
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        }
        
        function displaySystemStatusError(error) {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `
                <div style="text-align: center; color: #dc3545;">
                    <div style="font-weight: bold; margin-bottom: 10px;">Error Loading System Status</div>
                    <div style="margin-bottom: 15px;">${error}</div>
                    <button onclick="loadSystemStatus()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
            updateHealthStatusText('Error', 'status-error');
            
            // Update collapsible height if it's expanded
            const content = document.getElementById('health-content');
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        }

        function updateHealthStatusText(status, statusClass) {
            const statusText = document.getElementById('health-status-text');
            if (statusText) {
                statusText.textContent = status;
                statusText.className = statusClass;
            }
        }
        
        // Auto-refresh system status every 30 seconds
        setInterval(loadSystemStatus, 30000);

        // Save button state management
        let savedSettings = {};

        function setSaveButtonState(state) {
            const saveButton = document.getElementById('save-button');
            if (state === 'saved') {
                saveButton.classList.remove('unsaved');
                saveButton.classList.add('saved');
                saveButton.textContent = 'Settings Saved';
            } else if (state === 'unsaved') {
                saveButton.classList.remove('saved');
                saveButton.classList.add('unsaved');
                saveButton.textContent = 'Save Settings';
            }
        }

        function getCurrentSettings() {
            const debuggerOptions = [];
            const timeBtn = document.getElementById('debugger-time-btn');
            const colorKeyBtn = document.getElementById('debugger-color-key-btn');
            const stationStatusBtn = document.getElementById('debugger-station-status-btn');
            const rainbowBtn = document.getElementById('rainbow-mode-btn');
            
            if (timeBtn && timeBtn.classList.contains('on')) debuggerOptions.push('time');
            if (colorKeyBtn && colorKeyBtn.classList.contains('on')) debuggerOptions.push('color_key');
            if (stationStatusBtn && stationStatusBtn.classList.contains('on')) debuggerOptions.push('station_status');

            return {
                'route': document.getElementById('route').value,
                'bedtime_start': document.getElementById('bedtime-start').value || '22:00',
                'bedtime_end': document.getElementById('bedtime-end').value || '07:00',
                'brightness': document.getElementById('brightness').value,
                'display_mode': document.getElementById('display-mode').value,
                'power_switch': document.getElementById('power-switch-btn').classList.contains('on') ? 'on' : 'off',
                'debugger': debuggerOptions.sort().join(','), // Sort for consistent comparison
                'rainbow_mode': rainbowBtn && rainbowBtn.classList.contains('on') ? 'on' : 'off',
                'mbta_api_key': document.getElementById('mbta-api-key').value,
                // Color settings
                'stopped_color': document.getElementById('stopped-color').value,
                'incoming_color': document.getElementById('incoming-color').value,
                'transit_color': document.getElementById('transit-color').value,
                'min_speed_color': document.getElementById('min-speed-color').value,
                'max_speed_color': document.getElementById('max-speed-color').value,
                'null_speed_color': document.getElementById('null-speed-color').value,
                'min_occupancy_color': document.getElementById('min-occupancy-color').value,
                'max_occupancy_color': document.getElementById('max-occupancy-color').value,
                'null_occupancy_color': document.getElementById('null-occupancy-color').value
            };
        }

        function storeCurrentSettings() {
            savedSettings = getCurrentSettings();
        }

        function hasSettingsChanged() {
            const currentSettings = getCurrentSettings();
            return JSON.stringify(currentSettings) !== JSON.stringify(savedSettings);
        }

        function checkForChanges() {
            if (hasSettingsChanged()) {
                setSaveButtonState('unsaved');
            } else {
                setSaveButtonState('saved');
            }
        }

        // Add event listeners for all form elements to detect changes
        function addChangeListeners() {
            // Add listeners to all input elements
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', checkForChanges);
                input.addEventListener('input', checkForChanges);
            });

            // Add listeners to toggle buttons
            const originalToggleButton = window.toggleButton;
            window.toggleButton = function(buttonId) {
                originalToggleButton(buttonId);
                // Small delay to ensure DOM is updated
                setTimeout(checkForChanges, 10);
            };
        }

        // Initialize change detection when page loads
        document.addEventListener('DOMContentLoaded', () => {
            addChangeListeners();
            // Note: Initial settings will be stored by loadSettings() function
        });
    </script>

    <!-- Footer with attribution and copyright -->
    <footer style="margin-top: 40px; padding: 20px 0; border-top: 2px solid #ddd; text-align: center; color: #666; font-size: 12px;">
        <p style="margin: 8px 0;">
            Data from the Massachusetts Department of Transportation (MassDOT) and Massachusetts Bureau of Geographic Information (MassGIS); provided "as is" and without endorsement
        </p>
        <p style="margin: 8px 0;">
            &copy; 2025 Thomas Underwood
        </p>
    </footer>
</body>
</html>
